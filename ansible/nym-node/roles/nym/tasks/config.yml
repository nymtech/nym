---
# Useful when the host is behind a NAT
- name: Fetch the public IP address
  command: "curl -4 canhazip.com"
  register: ipv4
  changed_when: false
  failed_when: false

- name: Set public IP address
  set_fact:
    public_ip: "{{ ipv4.stdout | default(ansible_default_ipv4.address) }}"

- name: Initialize nym node
  # Delete the part from --hostname onward if you run  mode=mixnode only
  command:
    cmd: >
      {{ nym_install_dir }}/nym-node run
      --mode {{ mode }}
      --public-ips {{ public_ip }}
      --http-bind-address {{ http_bind_address }}
      --mixnet-bind-address {{ mixnet_bind_address }}
      --location {{ location }}
      {% if accept_operator_terms %}--accept-operator-terms-and-conditions{% endif %}

      {{ nym_extra_flags }}

      --hostname {{ hostname }}
      --wireguard-enabled {{ (wireguard_enabled | default('false') | bool) | ternary('true','false') }}
      --landing-page-assets-path {{ landing_page_assets_base_dir }}/{{ hostname }}/
      {% if nym_write_flag %}-w{% endif %}
      {% if nym_init_only_flag %}--init-only{% endif %}
      --announce-wss-port {{ wss_port }}


- name: Update nym description
  template:
    src: description.toml.j2
    dest: /root/.nym/nym-nodes/default-nym-node/data/description.toml
