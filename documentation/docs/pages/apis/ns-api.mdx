import { Callout } from 'nextra/components'

# Node Status API
The Node Status API serves information about individual `nym-nodes` in the Mixnet, such as which role they are operating in, statistics about them, services such as Network Requesters, as well as summaries of the state of the Mixnet.

<Callout type="info">
We recommend that developers building applications such as explorers or analytics interfaces about the Mixnet run their own instance of the API, in order to promote a robust network of downstream services, and spread the load of API calls amongst as many endpoints as possible.
</Callout>

## Components
The Node Status API is made up of 3 components:
- `nym-node-status-api`
- `nym-node-status-client`
- `nym-node-status-agent`

The API stores its data in a local SQLite database. It periodically gets most of its data from a [NymAPI](./nym-api) instance, and for instances also running with the Gateway Probe, uses the stored topology to conduct performance probe tests.

## Gateway Probe
**Two of these components - the `-client` and `-agent`, are only necessary if you plan to run the Gateway Probe**, which performs periodic uptime and config checks of individual `nym-nodes` running as Gateways, and stores the results ([see here for an example of the output](https://harbourmaster.nymtech.net/) locally. It is entirely possible to run just the `-api` without Gateway Probe results if you just wish to present the rest of the data, which mostly comprises of the Mixnet topology. See [Run](#run) section below for examples of the different types of data each mode gives you.

## UI
Currently we are not shipping a UI component for the Node Status API. The [Harbourmaster](https://harbourmaster.nymtech.net/) frontend consumes this API, amongst other things, but this is an internal repo we use to experiment with new APIs and data on, so it is not public yet.

<Callout type="info">
We invite developers to roll their own UI for their Node Status API instance.
</Callout>

## Docker Images
Coming soon.

## Build
### Prerequisites
- Rust
- SQLite
- Get an `ipinfo` key following instructions [here](https://github.com/ipinfo/rust?tab=readme-ov-file#getting-started). Set it as an env var called `API_TOKEN`.

### Compilation
```shell
cargo build --release --package nym-node-status-api --package nym-node-status-agent --package nym-node-status-client
```

## Run
Since the Node Status API depends on both flags and environmental variables, it might be easier to run the binary via a script like the one below - this this script essentially just `source`s the defined `.env` file after exporting certain binary-specific variables, and then runs the binary. This script is assumes it is being run from `nym/node-status-api`: modify as appropriate for your own setup. If you prefer to instead have the `.env` files outside of the monorepo, you can find them in the codebase [here](https://github.com/nymtech/nym/tree/master/envs).

```bash
#!/bin/bash

set -e

user_rust_log_preference=$RUST_LOG
export ENVIRONMENT=${ENVIRONMENT:-"mainnet"} # change to whatever env you wish to run for, e.g. "sandbox"
export NYM_API_CLIENT_TIMEOUT=60
export EXPLORER_CLIENT_TIMEOUT=60
export NODE_STATUS_API_TESTRUN_REFRESH_INTERVAL=120
export IPINFO_API_TOKEN=<YOUR_IPINFO_API_KEY>

script_dir=$(dirname $(realpath "$0"))
monorepo_root=$(realpath "${script_dir}/..") # e.g. if you wish to run this from nym/nym-node-status-api/

set -a
source "${monorepo_root}/envs/${ENVIRONMENT}.env"
echo ${monorepo_root}/envs/${ENVIRONMENT}.env
set +a
export RUST_LOG=${user_rust_log_preference:-debug} # debug is useful to check everything is working, but quite verbose

# To test everything is properly set: comment out or delete once your setup is stable
echo "Verifying environment variables were properly sourced:"
echo "RUST_LOG=${RUST_LOG}"
echo "BECH32_PREFIX=${BECH32_PREFIX}"
echo "NETWORK_NAME=${NETWORK_NAME}"

cargo run --package nym-node-status-api -- --ipinfo-api-token IPINFO_API_TOKEN
```

### Functionality Without Gateway Probe
Without the Gateway Probe functionality, you will see a lot of logging like this:
```shell
2025-02-28T17:10:48.340293Z DEBUG ThreadId(07) data_monitor:location_cached: nym-node-status-api/nym-node-status-api/src/monitor/mod.rs:305: No geodata could be retrieved for 2171
```

Furthermore, data is restricted to information that doesn't involve Probe results, such as `routing` and `config` scores:
```shell
{
      "gateway_identity_key": "27SuZ1RGVukQRr9zp8J1hf4w8iocPHmLWYLDdoJ5o27h",
      "self_described": {
        "authenticator": {
          "address": "Fs5yJ31ZXJWBb99x6tWUJX4sRJXrbdgqwXxdeta56rnB.5jkHtFMNGucYX3WnX4v44BDHzkjPH2BS2K9MA6LNtb3a@27SuZ1RGVukQRr9zp8J1hf4w8iocPHmLWYLDdoJ5o27h"
        },
        "auxiliary_details": {
          "accepted_operator_terms_and_conditions": true,
          "announce_ports": {
            "mix_port": null,
            "verloc_port": null
          },
          "location": "SG"
        },
        "build_information": {
          "binary_name": "nym-node",
          "build_timestamp": "2025-02-04T09:35:42.399220545Z",
          "build_version": "1.4.0",
          "cargo_profile": "release",
          "cargo_triple": "x86_64-unknown-linux-gnu",
          "commit_branch": "HEAD",
          "commit_sha": "4c2bf3642e8eec0d55c7753e14429d73ac2d0e99",
          "commit_timestamp": "2025-02-04T10:29:48.000000000+01:00",
          "rustc_channel": "stable",
          "rustc_version": "1.84.1"
        },
        "declared_role": {
          "entry": true,
          "exit_ipr": true,
          "exit_nr": true,
          "mixnode": false
        },
        "host_information": {
          "hostname": "sg-node2.spectredao.net",
          "ip_address": [
            "172.86.82.47"
          ],
          "keys": {
            "ed25519": "27SuZ1RGVukQRr9zp8J1hf4w8iocPHmLWYLDdoJ5o27h",
            "x25519": "HKgjSeSMtLFN2bcFwkJbdDTbbKku7TRgu9LbZxxZSuvb",
            "x25519_noise": null
          }
        },
        "ip_packet_router": {
          "address": "75qJ9t3zgeKAw8m7k5EmS4wmzd3MzC1tWfPFwBRxzxcc.6ccjHAJuHUSpoS2rHP5wMKNEJmJbFCCbPdXNh9zrcaaX@27SuZ1RGVukQRr9zp8J1hf4w8iocPHmLWYLDdoJ5o27h"
        },
        "last_polled": "2025-02-28 16:07:58.590825791 +00:00:00",
        "mixnet_websockets": {
          "ws_port": 9000,
          "wss_port": 9001
        },
        "network_requester": {
          "address": "56FDRhroAWTzqyHGB72pEhAENzCGR7EHoDurE9QmEHaF.4Gv2fBLuGCf3Lnk8KhoTaPvahuHXDaNj1dBvD9tB1Fyf@27SuZ1RGVukQRr9zp8J1hf4w8iocPHmLWYLDdoJ5o27h",
          "uses_exit_policy": true
        },
        "wireguard": {
          "port": 51822,
          "public_key": "BX1oS6xmCjebu4UQNkRw6vHzDhUhNbujKAvDTdodfyFN"
        }
      },
      "explorer_pretty_bond": {
        "identity_key": "27SuZ1RGVukQRr9zp8J1hf4w8iocPHmLWYLDdoJ5o27h",
        "location": {
          "latitude": 0.0,
          "longitude": 0.0,
          "two_letter_iso_country_code": ""
        },
        "owner": "n1xqcd4z76h9tgjmwgnss77762lm5vzk4646ey4h",
        "pledge_amount": {
          "amount": "100000000",
          "denom": "unym"
        }
      },
      "last_probe_result": null,
      "last_testrun_utc": null,
      "last_updated_utc": "2025-02-28T17:11:26+00:00",
      "routing_score": 0.0,
      "config_score": 0,
      "performance": 78
    },
```

### Functionality with Gateway Probe
TODO: if you do want to run with GWP, modify as such: ...

### Ports
By default the API listens on `8000`, so you will need to configure this post to be reachable on your remote server. You can modify this with the `--http_port` flag.
