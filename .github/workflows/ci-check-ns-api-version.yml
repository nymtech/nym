name: ci-check-ns-api-version

on:
  pull_request:
    paths:
      - "nym-node-status-api/**"

      # TODO dz parse Cargo.toml version
      # TODO dz check if there is a harbor image with that tag already
      # TODO dz if there is, return non-zero

env:
  WORKING_DIRECTORY: "nym-node-status-api/nym-node-status-api"

jobs:
  build-container:
    runs-on: arc-ubuntu-22.04-dind
    steps:
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: harbor.nymte.ch
          username: ${{ secrets.HARBOR_ROBOT_USERNAME }}
          password: ${{ secrets.HARBOR_ROBOT_SECRET }}

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get version from cargo.toml
        uses: mikefarah/yq@v4.45.1
        id: get_version
        with:
          cmd: yq -oy '.package.version' ${{ env.WORKING_DIRECTORY }}/Cargo.toml

      - name: Check if tag exists
        uses: actions/checkout@v4
      - run: |
          git ls-remote --tags origin
          tag=${{ env.WORKING_DIRECTORY }}-${{ steps.get_version.outputs.result }}
          if git ls-remote --tags origin | grep -q "refs/tags/$tag$" ; then
          # git tag -l | grep -q "^$tag"; then
              echo "Tag ${tag} ALREADY EXISTS on the remote"
              exit 1
          else
              echo "Tag ${tag} does not exist on the remote"
          fi
